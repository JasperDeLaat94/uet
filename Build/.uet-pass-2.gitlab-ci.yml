"Build Win UET Pass 2":
  stage: Build Pass 2
  tags:
    - redpoint-games-windows
  needs:
    - Timestamp
    - "Build Win OpenGE Shim"
    - "Build Mac OpenGE Shim"
    - "Build Linux OpenGE Shim"
    - "Build Mac Logging"
    - "Build AutoDiscovery"
    - "Build Win UET Pass 1"
    - "Build Mac UET Pass 1"
    - job: "Build and Test Libraries on Windows"
      artifacts: false
  interruptible: true
  script: |
    $PackageVersion = (Get-Content -Raw -Path "package.version").Trim()
    dotnet msbuild -restore -t:Publish -p:RuntimeIdentifier=win-x64 -p:OpenGEShimRuntimeIdentifier=win-x64 -p:Configuration=Release -p:EmbeddingCrossPlatform=true -p:BaseUetVersion=$PackageVersion -p:PackageVersion=$PackageVersion -p:OpenGEShimIsAlreadyBuilt=true UET/uet/uet.csproj
    if ($LastExitCode -ne 0) {
      Write-Host "Publish win-x64 (uet.csproj) failed with exit code $LastExitCode"
      exit $LastExitCode 
    }
  artifacts:
    paths:
      - "UET/uet/bin/Release/net8.0/win-x64/publish/uet.exe"

"Build Mac UET Pass 2":
  stage: Build Pass 2
  tags:
    - redpoint-games-mac
  needs:
    - Timestamp
    - "Build Win OpenGE Shim"
    - "Build Mac OpenGE Shim"
    - "Build Linux OpenGE Shim"
    - "Build Mac Logging"
    - "Build AutoDiscovery"
    - "Build Win UET Pass 1"
    - "Build Mac UET Pass 1"
    - job: "Build and Test Libraries on macOS"
      artifacts: false
  interruptible: true
  script: |
    PACKAGE_VERSION=$(cat package.version | tr -d '\n')
    echo "Package version: $PACKAGE_VERSION"
    dotnet msbuild -restore -t:Publish -p:RuntimeIdentifier=osx-arm64 -p:OpenGEShimRuntimeIdentifier=osx-arm64 -p:Configuration=Release -p:EmbeddingCrossPlatform=true -p:BaseUetVersion=$PACKAGE_VERSION -p:PackageVersion=$PACKAGE_VERSION -p:OpenGEShimIsAlreadyBuilt=true UET/uet/uet.csproj
    # Ensure the thing we built will actually run...
    ./UET/uet/bin/Release/net8.0/osx-arm64/publish/uet --help
  artifacts:
    paths:
      - "UET/uet/bin/Release/net8.0/osx-arm64/publish/uet"